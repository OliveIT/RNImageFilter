package iyegoroff.RNColorMatrixImageFilters;

import com.facebook.react.views.view.ReactViewGroup;

import android.content.Context;
import android.graphics.ColorMatrix;
import android.graphics.ColorMatrixColorFilter;
import android.graphics.Canvas;
import android.util.Log;
import android.view.View;
import android.widget.ImageView;
import android.graphics.Bitmap;
import android.graphics.drawable.BitmapDrawable;
import android.graphics.drawable.Drawable;
import android.util.Base64;

import java.io.ByteArrayOutputStream;

import com.facebook.react.common.ReactConstants;
import com.facebook.react.bridge.ReadableArray;

public class RNColorMatrixImageFilter extends ReactViewGroup {

  private ColorMatrixColorFilter mFilter = new ColorMatrixColorFilter(new ColorMatrix());
  private Boolean _isTarget = false;

  public RNColorMatrixImageFilter(Context context) {
    super(context);
  }

  public void setMatrix(ReadableArray matrix) {
    float[] m = new float[matrix.size()];

    for (int i = 0; i < m.length; i++) {
      m[i] = (float) matrix.getDouble(i);
    }

    mFilter = new ColorMatrixColorFilter(m);

    invalidate();
  }

  public void setTarget(Boolean isTarget) {
    _isTarget = isTarget;
  }

  @Override
  public void draw(Canvas canvas) {
    for (int i = 0; i < this.getChildCount(); i++) {
      View child = this.getChildAt(i);

      if (child instanceof ImageView) {
        ((ImageView) child).setColorFilter(mFilter);

        if (_isTarget) {
            fetchImage((ImageView) child);
        }
        break;
      }
    }

    super.draw(canvas);
  }

  public void fetchImage(ImageView view) {
    view.buildDrawingCache();
    Bitmap bitmap = view.getDrawingCache();
    ByteArrayOutputStream stream = new ByteArrayOutputStream();
    bitmap.compress(Bitmap.CompressFormat.JPEG, 100, stream);
    byte[] imageInByte = stream.toByteArray();
    String imgString = Base64.encodeToString(imageInByte, Base64.NO_WRAP);

    ReactInstanceManager reactInstanceManager = reactNativeHost.getReactInstanceManager();
    ReactContext reactContext = reactInstanceManager.getCurrentReactContext();

    CatalystInstance catalystInstance = reactContext.getCatalystInstance();
    WritableNativeArray params = new WritableNativeArray();
    params.pushString(imgString);
    catalystInstance.callFunction("JavaScriptVisibleToJava", "setImageBufferBase64", params);
  }
}
